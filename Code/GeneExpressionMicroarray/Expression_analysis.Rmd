---
title: "Ctr Infection in End1 cells 24h/48h - DGE analysis"
author: "Hilmar Berger"
output: 
 html_document:
    toc: true
    toc_depth: 3
    toc_float: false
    number_sections: true
    code_folding: hide
    
pdf_document:
    fig_caption: true
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%S')`"
---


```{r,  results='hide', messages=FALSE}
rm(list=ls())
suppressMessages(library(limma))
suppressMessages(library(xlsx))
suppressMessages(library(pheatmap))
library(xtable)
library(reshape2)

load("../../Data/Processed/GeneExpression/CtrD_Inf_micro_array_preprocessed_data.Rdata")
exp_design = ed

result_folder = "../../Results/GeneExpression/"
```

# Introduction

This is a reanalysis of micro arrays generated by Cindrilla Chumduri using End1 cells and infecting with C.trachomatis serovar D for 24h or 48h. Arrays are Agilent design ID 014850 in an dual color design. 
Original analysis was done using Rosetta Resolver. This new analysis uses the separate-channel analysis method as described by Smyth and Altman (BMC Bioinformatics, 2013) which allows to pool replicates across arrays in the two-color design, increasing the power to detect smaller changes.

We compare the infected cells 24h or 48h after infection to the corresponding non-infected timepoints. 

# MDS

```{r,  fig.width=8, fig.height=8}
################################################################################
## MDS on normalized data 
cp = palette(rainbow(11))
data_inp = t(as.matrix(MA.n))

d <- dist(data_inp) # euclidean distances between the rows
fit <- cmdscale(d,eig=TRUE, k=2) # k is the number of dim

# plot solution
x <- fit$points[,1]
y <- fit$points[,2]
cc = cp[as.numeric(factor(ed[rownames(data_inp),]$Condition))]
plot(x, y, xlab="Coordinate 1", ylab="Coordinate 2", main="Metric MDS, all samples", type="n", ylim=c(min(y)-50, max(y)+50), xlim=c(min(x)-50, max(x)+200))
points(x, y, col=cc)
#text(x,y,labels=ed[rownames(data_inp),]$sample_ID, col=cp[as.numeric(factor(ed[rownames(data_inp),]$Tissue.Status))])
text(x,y,labels=ed[rownames(data_inp),]$Short, col=cc[as.numeric(as.factor(ed[rownames(data_inp),]$Condition))], cex=.8, pos=4)
################################################################################
```

# DGE

We ran the following analyses here:

- Ignoring the fact that dye swaps are technical replicates instead of biological ones we use the single channel analysis provided in LIMMA to compare timepoints and conditions:

     - CtrD infection vs not infected at 24h [24h_InfVsNI]
     - CtrD infection vs not infected at 48h [48h_InfVsNI]
     
Note that the way technical replicates are treated will bias p-values towards lower values. This has to be considered when judging significance of genes.      

```{r}
all_results = list()
```

```{r, DGE,  fig.width=8, fig.height=8}
# Single Channel analysis
MA.n.1_8 = MA.n[,1:8]
targets2 = targetsA2C(exp_design[1:8,])
u <- unique(targets2$Target)
f <- factor(targets2$Target, levels=u)
design <- model.matrix(~0+f)
colnames(design) <- u
corfit <- intraspotCorrelation(MA.n.1_8, design)
fit <- lmscFit(MA.n.1_8, design, correlation=corfit$consensus)
cont.matrix <- makeContrasts("Ctr_24h-NI_24h",levels=design)
fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)
all_results[["24h_InfVsNI"]] = topTable(fit2, adjust="BH",number=nrow(fit2))

cont.matrix <- makeContrasts("Ctr_48h-NI_48h",levels=design)
fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)
all_results[["48h_InfVsNI"]] = topTable(fit2, adjust="BH",number=nrow(fit2))

```


```{r, volcano, fig.width=8, fig.height=8}
all_target_conditions = names(all_results)
par(mfrow=c(1,2))

for (tc in all_target_conditions) {
  r = all_results[[tc]]
  plot(r$logFC, -log10(r$adj.P.Val),xlab="log2 Fold Change",ylab="-log10(adj. p-val)", ylim=c(0,max(2,max(-log10(r$adj.P.Val),na.rm=T))))
  title(main=tc, sub=paste("(",nrow(subset(r, adj.P.Val < 0.05))," signif. DE genes)",sep="") )
  abline(h=-log10(0.05),col="red")
}
```


```{r, write_tabs}
###############################################################################################################
# Write Result Files
###############################################################################################################

output_file_prefix = paste(result_folder,"Differential_expression_results_", sep="/")
selected_cols = c("ProbeName", "GeneSymbol", "TargetID", "GeneName","logFC","AveExpr","t","P.Value","adj.P.Val" )
for (tc in names(all_results)) {
  filename = paste(output_file_prefix, tc, ".txt", sep="" )
  write.table(all_results[[tc]][,selected_cols], file= filename, row.names=F , sep="\t", dec=".", quote=F)
}

```

```{r}
R.avg <- avereps(RG$R, ID=RG$genes$ProbeName)
G.avg <- avereps(RG$G, ID=RG$genes$ProbeName)
colnames(R.avg) = paste(ed[colnames(R.avg),]$Cy5,"_Cy5","_",ed[colnames(R.avg),]$scan_ID,sep="")
colnames(G.avg) = paste(ed[colnames(G.avg),]$Cy3,"_Cy3","_",ed[colnames(G.avg),]$scan_ID,sep="")

intensity_matrix = cbind(R.avg, G.avg)
norm_intensity_matrix = normalizeBetweenArrays(intensity_matrix, method="quantile")
```

```{r}
p2s = unique(MA.n$genes[,c("ProbeName","GeneSymbol","GeneName")])
rownames(p2s) = p2s$ProbeName

norm_exp_df = as.data.frame(norm_intensity_matrix)
norm_exp_df$GeneSymbol = p2s[rownames(norm_exp_df),]$GeneSymbol
norm_exp_df$GeneDescription = p2s[rownames(norm_exp_df),]$GeneName
filename = paste(result_folder,"Normalized_expression_data_single_channel.txt",sep="/")
write.table(norm_exp_df, file=filename,sep="\t",col.names=NA)
```

The following result files have been written: 

- Differential_expression_results_24h_InfVsNI.txt
- Differential_expression_results_48h_InfVsNI.txt
- Normalized_expression_data_single_channel.txt

```{r}
filename = paste(result_folder,"DGE_results.Rdata",sep="/")
save(all_results, exp_design, norm_intensity_matrix, MA.n, file=filename)
```

```{r}
sessionInfo()
```


